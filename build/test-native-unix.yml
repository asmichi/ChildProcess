parameters:
  - name: platform
    type: string
    values:
    - osx
    - linux

steps:
  - template: 'prepare-variables.yml'
  - template: 'prepare-dotnet.yml'

  - task: DownloadPipelineArtifact@2
    inputs:
      source: current
      artifact: 'ChildProcess.Native-linux'
      path: '$(Build.SourcesDirectory)/bin/ChildProcess.Native'

  - task: DownloadPipelineArtifact@2
    inputs:
      source: current
      artifact: 'ChildProcess.Native-osx'
      path: '$(Build.SourcesDirectory)/bin/ChildProcess.Native'

  - task: Bash@3
    inputs:
      targetType: 'inline'
      script: 'chmod -R +x $(Build.SourcesDirectory)/bin/ChildProcess.Native'

  - template: 'build-and-test.yml'
    parameters:
      platform: ${{ parameters.platform }}
      additionalArguments: '-p:AddImportSearchPathAssemblyDirectory=true' # Workaround for https://github.com/dotnet/sdk/issues/1088
